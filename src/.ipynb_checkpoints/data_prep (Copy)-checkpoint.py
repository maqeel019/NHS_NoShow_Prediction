{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "68d91c94-01e0-49f5-9e37-6afaaf0c57a2",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Ethnicity dataset enriched with realistic tele proportions:\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Ethnicity</th>\n",
       "      <th>Unnamed: 1</th>\n",
       "      <th>All</th>\n",
       "      <th>Attended_First</th>\n",
       "      <th>Attended_First_Tele</th>\n",
       "      <th>Attended_Subseq</th>\n",
       "      <th>Attended_Subseq_Tele</th>\n",
       "      <th>Attended_Unknown</th>\n",
       "      <th>Percent</th>\n",
       "      <th>NoShow_Prob</th>\n",
       "      <th>Tele_Proportion</th>\n",
       "      <th>Face_Proportion</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Unknown</td>\n",
       "      <td>Total Activity</td>\n",
       "      <td>113225153</td>\n",
       "      <td>32380319</td>\n",
       "      <td>5036934</td>\n",
       "      <td>61066503</td>\n",
       "      <td>14725395</td>\n",
       "      <td>16002</td>\n",
       "      <td>1.000</td>\n",
       "      <td>0.000141</td>\n",
       "      <td>0.174540</td>\n",
       "      <td>0.825319</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>British (White)</td>\n",
       "      <td>British (White)</td>\n",
       "      <td>67215444</td>\n",
       "      <td>18360239</td>\n",
       "      <td>2968057</td>\n",
       "      <td>36456258</td>\n",
       "      <td>9427068</td>\n",
       "      <td>3822</td>\n",
       "      <td>0.594</td>\n",
       "      <td>0.000057</td>\n",
       "      <td>0.184409</td>\n",
       "      <td>0.815534</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Irish (White)</td>\n",
       "      <td>Irish (White)</td>\n",
       "      <td>700078</td>\n",
       "      <td>178717</td>\n",
       "      <td>31613</td>\n",
       "      <td>389847</td>\n",
       "      <td>99802</td>\n",
       "      <td>99</td>\n",
       "      <td>0.006</td>\n",
       "      <td>0.000141</td>\n",
       "      <td>0.187715</td>\n",
       "      <td>0.812144</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>Any other White background</td>\n",
       "      <td>Any other White background</td>\n",
       "      <td>5701495</td>\n",
       "      <td>1700972</td>\n",
       "      <td>251671</td>\n",
       "      <td>3092713</td>\n",
       "      <td>655001</td>\n",
       "      <td>1138</td>\n",
       "      <td>0.050</td>\n",
       "      <td>0.000200</td>\n",
       "      <td>0.159024</td>\n",
       "      <td>0.840777</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>White and Black Caribbean (Mixed)</td>\n",
       "      <td>White and Black Caribbean (Mixed)</td>\n",
       "      <td>439143</td>\n",
       "      <td>122171</td>\n",
       "      <td>17853</td>\n",
       "      <td>247636</td>\n",
       "      <td>51387</td>\n",
       "      <td>96</td>\n",
       "      <td>0.004</td>\n",
       "      <td>0.000219</td>\n",
       "      <td>0.157671</td>\n",
       "      <td>0.842111</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>White and Black African (Mixed)</td>\n",
       "      <td>White and Black African (Mixed)</td>\n",
       "      <td>238632</td>\n",
       "      <td>68906</td>\n",
       "      <td>9462</td>\n",
       "      <td>133261</td>\n",
       "      <td>26907</td>\n",
       "      <td>96</td>\n",
       "      <td>0.002</td>\n",
       "      <td>0.000402</td>\n",
       "      <td>0.152406</td>\n",
       "      <td>0.847191</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>White and Asian (Mixed)</td>\n",
       "      <td>White and Asian (Mixed)</td>\n",
       "      <td>344524</td>\n",
       "      <td>98949</td>\n",
       "      <td>13624</td>\n",
       "      <td>193304</td>\n",
       "      <td>38600</td>\n",
       "      <td>47</td>\n",
       "      <td>0.003</td>\n",
       "      <td>0.000136</td>\n",
       "      <td>0.151583</td>\n",
       "      <td>0.848281</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>Any other Mixed background</td>\n",
       "      <td>Any other Mixed background</td>\n",
       "      <td>789370</td>\n",
       "      <td>241577</td>\n",
       "      <td>32801</td>\n",
       "      <td>428439</td>\n",
       "      <td>86394</td>\n",
       "      <td>159</td>\n",
       "      <td>0.007</td>\n",
       "      <td>0.000201</td>\n",
       "      <td>0.151000</td>\n",
       "      <td>0.848798</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>Indian (Asian or Asian British)</td>\n",
       "      <td>Indian (Asian or Asian British)</td>\n",
       "      <td>2869054</td>\n",
       "      <td>817341</td>\n",
       "      <td>117359</td>\n",
       "      <td>1631402</td>\n",
       "      <td>302408</td>\n",
       "      <td>544</td>\n",
       "      <td>0.025</td>\n",
       "      <td>0.000190</td>\n",
       "      <td>0.146309</td>\n",
       "      <td>0.853502</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>Pakistani (Asian or Asian British)</td>\n",
       "      <td>Pakistani (Asian or Asian British)</td>\n",
       "      <td>2504534</td>\n",
       "      <td>692015</td>\n",
       "      <td>101083</td>\n",
       "      <td>1464970</td>\n",
       "      <td>246309</td>\n",
       "      <td>157</td>\n",
       "      <td>0.022</td>\n",
       "      <td>0.000063</td>\n",
       "      <td>0.138705</td>\n",
       "      <td>0.861232</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                            Ethnicity                          Unnamed: 1  \\\n",
       "0                             Unknown                      Total Activity   \n",
       "1                     British (White)                     British (White)   \n",
       "2                       Irish (White)                       Irish (White)   \n",
       "3          Any other White background          Any other White background   \n",
       "4   White and Black Caribbean (Mixed)   White and Black Caribbean (Mixed)   \n",
       "5     White and Black African (Mixed)     White and Black African (Mixed)   \n",
       "6             White and Asian (Mixed)             White and Asian (Mixed)   \n",
       "7          Any other Mixed background          Any other Mixed background   \n",
       "8     Indian (Asian or Asian British)     Indian (Asian or Asian British)   \n",
       "9  Pakistani (Asian or Asian British)  Pakistani (Asian or Asian British)   \n",
       "\n",
       "         All  Attended_First  Attended_First_Tele  Attended_Subseq  \\\n",
       "0  113225153        32380319              5036934         61066503   \n",
       "1   67215444        18360239              2968057         36456258   \n",
       "2     700078          178717                31613           389847   \n",
       "3    5701495         1700972               251671          3092713   \n",
       "4     439143          122171                17853           247636   \n",
       "5     238632           68906                 9462           133261   \n",
       "6     344524           98949                13624           193304   \n",
       "7     789370          241577                32801           428439   \n",
       "8    2869054          817341               117359          1631402   \n",
       "9    2504534          692015               101083          1464970   \n",
       "\n",
       "   Attended_Subseq_Tele  Attended_Unknown  Percent  NoShow_Prob  \\\n",
       "0              14725395             16002    1.000     0.000141   \n",
       "1               9427068              3822    0.594     0.000057   \n",
       "2                 99802                99    0.006     0.000141   \n",
       "3                655001              1138    0.050     0.000200   \n",
       "4                 51387                96    0.004     0.000219   \n",
       "5                 26907                96    0.002     0.000402   \n",
       "6                 38600                47    0.003     0.000136   \n",
       "7                 86394               159    0.007     0.000201   \n",
       "8                302408               544    0.025     0.000190   \n",
       "9                246309               157    0.022     0.000063   \n",
       "\n",
       "   Tele_Proportion  Face_Proportion  \n",
       "0         0.174540         0.825319  \n",
       "1         0.184409         0.815534  \n",
       "2         0.187715         0.812144  \n",
       "3         0.159024         0.840777  \n",
       "4         0.157671         0.842111  \n",
       "5         0.152406         0.847191  \n",
       "6         0.151583         0.848281  \n",
       "7         0.151000         0.848798  \n",
       "8         0.146309         0.853502  \n",
       "9         0.138705         0.861232  "
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "\n",
    "# ------------------------------\n",
    "# 1️⃣ Load and clean the Ethnicity dataset\n",
    "# ------------------------------\n",
    "ethnic_df = pd.read_excel(\"../data/hosp-epis-stat-outp-ethn-cat-2024-25-tab.xlsx\", sheet_name=0)\n",
    "ethnic_df.columns = ethnic_df.columns.str.strip()\n",
    "ethnic_clean = ethnic_df[ethnic_df['Ethnic Category'] != \"Total Activity\"].copy()\n",
    "ethnic_clean['Ethnic Category'] = ethnic_clean['Ethnic Category'].astype(str).str.strip()\n",
    "\n",
    "ethnic_clean.rename(columns={\n",
    "    'Ethnic Category': 'Ethnicity',\n",
    "    'All Attendances': 'All',\n",
    "    'Attended first appointment': 'Attended_First',\n",
    "    'Attended first tele consultation': 'Attended_First_Tele',\n",
    "    'Attended subsequent appointment': 'Attended_Subseq',\n",
    "    'Attended subsequent tele consultation': 'Attended_Subseq_Tele',\n",
    "    'Attended but first / subsequent / tele unknown': 'Attended_Unknown',\n",
    "    'Percentage of all attendances': 'Percent'\n",
    "}, inplace=True)\n",
    "\n",
    "ethnicity_map = {\n",
    "    'A': 'British (White)',\n",
    "    'B': 'Irish (White)',\n",
    "    'C': 'Any other White background',\n",
    "    'D': 'White and Black Caribbean (Mixed)',\n",
    "    'E': 'White and Black African (Mixed)',\n",
    "    'F': 'White and Asian (Mixed)',\n",
    "    'G': 'Any other Mixed background',\n",
    "    'H': 'Indian (Asian or Asian British)',\n",
    "    'J': 'Pakistani (Asian or Asian British)',\n",
    "    'K': 'Bangladeshi (Asian or Asian British)',\n",
    "    'L': 'Any other Asian background',\n",
    "    'M': 'Caribbean (Black or Black British)',\n",
    "    'N': 'African (Black or Black British)',\n",
    "    'P': 'Any other Black background',\n",
    "    'R': 'Chinese (other ethnic group)',\n",
    "    'S': 'Any other ethnic group',\n",
    "    'Z': 'Not stated',\n",
    "    '99': 'Not Known'\n",
    "}\n",
    "\n",
    "ethnic_clean['Ethnicity'] = ethnic_clean['Ethnicity'].map(ethnicity_map).fillna('Unknown')\n",
    "\n",
    "# ------------------------------\n",
    "# 2️⃣ Compute No-Show probability per Ethnicity\n",
    "# ------------------------------\n",
    "ethnic_clean['NoShow_Prob'] = 1 - (\n",
    "    (ethnic_clean['Attended_First'] + ethnic_clean['Attended_First_Tele'] +\n",
    "     ethnic_clean['Attended_Subseq'] + ethnic_clean['Attended_Subseq_Tele']) /\n",
    "    ethnic_clean['All']\n",
    ")\n",
    "\n",
    "# ------------------------------\n",
    "# 3️⃣ Compute Tele vs Face-to-Face proportions\n",
    "# ------------------------------\n",
    "ethnic_clean['Tele_Proportion'] = (\n",
    "    ethnic_clean['Attended_First_Tele'] + ethnic_clean['Attended_Subseq_Tele']\n",
    ") / ethnic_clean['All']\n",
    "\n",
    "ethnic_clean['Face_Proportion'] = (\n",
    "    ethnic_clean['Attended_First'] + ethnic_clean['Attended_Subseq']\n",
    ") / ethnic_clean['All']\n",
    "\n",
    "\n",
    "print(\"Ethnicity dataset enriched with realistic tele proportions:\")\n",
    "ethnic_clean.head(10)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "a46df5af-2ada-4bc6-967e-e57c227b0cb6",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "IMD sheet cleaned with NoShow probabilities:\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>IMD_Decile</th>\n",
       "      <th>All</th>\n",
       "      <th>Attended_First</th>\n",
       "      <th>Attended_First_Tele</th>\n",
       "      <th>Attended_Subseq</th>\n",
       "      <th>Attended_Subseq_Tele</th>\n",
       "      <th>Attended_Unknown</th>\n",
       "      <th>Percent</th>\n",
       "      <th>NoShow_Prob</th>\n",
       "      <th>Tele_Proportion</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Most deprived 10%</td>\n",
       "      <td>10929927</td>\n",
       "      <td>3056186</td>\n",
       "      <td>482617</td>\n",
       "      <td>6078036</td>\n",
       "      <td>1311766</td>\n",
       "      <td>1322</td>\n",
       "      <td>0.097</td>\n",
       "      <td>0.000121</td>\n",
       "      <td>0.164172</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>More deprived 10-20%</td>\n",
       "      <td>11242959</td>\n",
       "      <td>3268125</td>\n",
       "      <td>485701</td>\n",
       "      <td>6112712</td>\n",
       "      <td>1373834</td>\n",
       "      <td>2587</td>\n",
       "      <td>0.099</td>\n",
       "      <td>0.000230</td>\n",
       "      <td>0.165396</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>More deprived 20-30%</td>\n",
       "      <td>11354423</td>\n",
       "      <td>3255661</td>\n",
       "      <td>496203</td>\n",
       "      <td>6174192</td>\n",
       "      <td>1425983</td>\n",
       "      <td>2384</td>\n",
       "      <td>0.100</td>\n",
       "      <td>0.000210</td>\n",
       "      <td>0.169290</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>More deprived 30-40%</td>\n",
       "      <td>11294332</td>\n",
       "      <td>3247341</td>\n",
       "      <td>501685</td>\n",
       "      <td>6080223</td>\n",
       "      <td>1463098</td>\n",
       "      <td>1985</td>\n",
       "      <td>0.100</td>\n",
       "      <td>0.000176</td>\n",
       "      <td>0.173962</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>More deprived 40-50%</td>\n",
       "      <td>11229225</td>\n",
       "      <td>3212134</td>\n",
       "      <td>502760</td>\n",
       "      <td>6030745</td>\n",
       "      <td>1482090</td>\n",
       "      <td>1496</td>\n",
       "      <td>0.099</td>\n",
       "      <td>0.000133</td>\n",
       "      <td>0.176758</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>Less deprived 40-50%</td>\n",
       "      <td>11352200</td>\n",
       "      <td>3274726</td>\n",
       "      <td>511049</td>\n",
       "      <td>6051513</td>\n",
       "      <td>1513375</td>\n",
       "      <td>1537</td>\n",
       "      <td>0.100</td>\n",
       "      <td>0.000135</td>\n",
       "      <td>0.178329</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>Less deprived 30-40%</td>\n",
       "      <td>11167381</td>\n",
       "      <td>3192096</td>\n",
       "      <td>501970</td>\n",
       "      <td>5970049</td>\n",
       "      <td>1501769</td>\n",
       "      <td>1497</td>\n",
       "      <td>0.099</td>\n",
       "      <td>0.000134</td>\n",
       "      <td>0.179428</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>Less deprived 20-30%</td>\n",
       "      <td>11134523</td>\n",
       "      <td>3172426</td>\n",
       "      <td>498262</td>\n",
       "      <td>5954328</td>\n",
       "      <td>1508249</td>\n",
       "      <td>1258</td>\n",
       "      <td>0.098</td>\n",
       "      <td>0.000113</td>\n",
       "      <td>0.180206</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>Less deprived 10-20%</td>\n",
       "      <td>11008175</td>\n",
       "      <td>3172326</td>\n",
       "      <td>491026</td>\n",
       "      <td>5857682</td>\n",
       "      <td>1486011</td>\n",
       "      <td>1130</td>\n",
       "      <td>0.097</td>\n",
       "      <td>0.000103</td>\n",
       "      <td>0.179597</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>Least deprived 10%</td>\n",
       "      <td>10793290</td>\n",
       "      <td>3059317</td>\n",
       "      <td>491136</td>\n",
       "      <td>5799828</td>\n",
       "      <td>1442279</td>\n",
       "      <td>730</td>\n",
       "      <td>0.095</td>\n",
       "      <td>0.000068</td>\n",
       "      <td>0.179131</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>Unknown/Non-UK Country</td>\n",
       "      <td>1718718</td>\n",
       "      <td>469981</td>\n",
       "      <td>74525</td>\n",
       "      <td>957195</td>\n",
       "      <td>216941</td>\n",
       "      <td>76</td>\n",
       "      <td>0.015</td>\n",
       "      <td>0.000044</td>\n",
       "      <td>0.169583</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                IMD_Decile       All  Attended_First  Attended_First_Tele  \\\n",
       "1        Most deprived 10%  10929927         3056186               482617   \n",
       "2     More deprived 10-20%  11242959         3268125               485701   \n",
       "3     More deprived 20-30%  11354423         3255661               496203   \n",
       "4     More deprived 30-40%  11294332         3247341               501685   \n",
       "5     More deprived 40-50%  11229225         3212134               502760   \n",
       "6     Less deprived 40-50%  11352200         3274726               511049   \n",
       "7     Less deprived 30-40%  11167381         3192096               501970   \n",
       "8     Less deprived 20-30%  11134523         3172426               498262   \n",
       "9     Less deprived 10-20%  11008175         3172326               491026   \n",
       "10      Least deprived 10%  10793290         3059317               491136   \n",
       "11  Unknown/Non-UK Country   1718718          469981                74525   \n",
       "\n",
       "    Attended_Subseq  Attended_Subseq_Tele  Attended_Unknown  Percent  \\\n",
       "1           6078036               1311766              1322    0.097   \n",
       "2           6112712               1373834              2587    0.099   \n",
       "3           6174192               1425983              2384    0.100   \n",
       "4           6080223               1463098              1985    0.100   \n",
       "5           6030745               1482090              1496    0.099   \n",
       "6           6051513               1513375              1537    0.100   \n",
       "7           5970049               1501769              1497    0.099   \n",
       "8           5954328               1508249              1258    0.098   \n",
       "9           5857682               1486011              1130    0.097   \n",
       "10          5799828               1442279               730    0.095   \n",
       "11           957195                216941                76    0.015   \n",
       "\n",
       "    NoShow_Prob  Tele_Proportion  \n",
       "1      0.000121         0.164172  \n",
       "2      0.000230         0.165396  \n",
       "3      0.000210         0.169290  \n",
       "4      0.000176         0.173962  \n",
       "5      0.000133         0.176758  \n",
       "6      0.000135         0.178329  \n",
       "7      0.000134         0.179428  \n",
       "8      0.000113         0.180206  \n",
       "9      0.000103         0.179597  \n",
       "10     0.000068         0.179131  \n",
       "11     0.000044         0.169583  "
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "\n",
    "# Load IMD sheet\n",
    "imd_df = pd.read_excel(\"../data/hosp-epis-stat-outp-imd-dec-2024-25-tab.xlsx\", sheet_name=0)\n",
    "\n",
    "# 1️⃣ Strip whitespace from all column names first\n",
    "imd_df.columns = imd_df.columns.str.strip()\n",
    "\n",
    "# 2️⃣ Drop total row using stripped column names\n",
    "imd_clean = imd_df[imd_df['Index of Multiple Deprivation Decile'] != \"Total Activity\"].copy()\n",
    "\n",
    "# 3️⃣ Rename columns for convenience\n",
    "imd_clean.rename(columns={\n",
    "    'Index of Multiple Deprivation Decile': 'IMD_Decile',\n",
    "    'All Attendances': 'All',\n",
    "    'Attended first appointment': 'Attended_First',\n",
    "    'Attended first tele consultation': 'Attended_First_Tele',\n",
    "    'Attended subsequent appointment': 'Attended_Subseq',\n",
    "    'Attended subsequent tele consultation': 'Attended_Subseq_Tele',\n",
    "    'Attended but first / subsequent / tele unknown1': 'Attended_Unknown',\n",
    "    'Percentage of all attendances': 'Percent'\n",
    "}, inplace=True)\n",
    "\n",
    "# 4️⃣ Compute No-Show probability\n",
    "imd_clean['NoShow_Prob'] = 1 - (\n",
    "    (imd_clean['Attended_First'] + imd_clean['Attended_First_Tele'] +\n",
    "     imd_clean['Attended_Subseq'] + imd_clean['Attended_Subseq_Tele']) /\n",
    "    imd_clean['All']\n",
    ")\n",
    "ethnic_clean['Tele_Proportion'] = (\n",
    "    (ethnic_clean['Attended_First_Tele'] + ethnic_clean['Attended_Subseq_Tele']) /\n",
    "    ethnic_clean['All']\n",
    ")\n",
    "\n",
    "imd_clean['Tele_Proportion'] = (\n",
    "    (imd_clean['Attended_First_Tele'] + imd_clean['Attended_Subseq_Tele']) /\n",
    "    imd_clean['All']\n",
    ")\n",
    "\n",
    "# Display\n",
    "print(\"IMD sheet cleaned with NoShow probabilities:\")\n",
    "imd_clean\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "f8b40360-284e-48d1-acca-d0f30f5e3c12",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Main_Specialty_Code</th>\n",
       "      <th>Main_Specialty_Desc</th>\n",
       "      <th>Age_Group</th>\n",
       "      <th>Attendance_Count</th>\n",
       "      <th>Gender</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>&amp;</td>\n",
       "      <td>Not Known</td>\n",
       "      <td>0</td>\n",
       "      <td>32968</td>\n",
       "      <td>All</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>100</td>\n",
       "      <td>General Surgery</td>\n",
       "      <td>0</td>\n",
       "      <td>4371</td>\n",
       "      <td>All</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>101</td>\n",
       "      <td>Urology</td>\n",
       "      <td>0</td>\n",
       "      <td>2989</td>\n",
       "      <td>All</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>107</td>\n",
       "      <td>Vascular Surgery</td>\n",
       "      <td>0</td>\n",
       "      <td>3</td>\n",
       "      <td>All</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>110</td>\n",
       "      <td>Trauma and Orthopaedics</td>\n",
       "      <td>0</td>\n",
       "      <td>48340</td>\n",
       "      <td>All</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  Main_Specialty_Code      Main_Specialty_Desc Age_Group Attendance_Count  \\\n",
       "1                   &                Not Known         0            32968   \n",
       "2                 100          General Surgery         0             4371   \n",
       "3                 101                  Urology         0             2989   \n",
       "4                 107         Vascular Surgery         0                3   \n",
       "5                 110  Trauma and Orthopaedics         0            48340   \n",
       "\n",
       "  Gender  \n",
       "1    All  \n",
       "2    All  \n",
       "3    All  \n",
       "4    All  \n",
       "5    All  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Main_Specialty_Code</th>\n",
       "      <th>Main_Specialty_Desc</th>\n",
       "      <th>Age_Group</th>\n",
       "      <th>Attendance_Count</th>\n",
       "      <th>Gender</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>&amp;</td>\n",
       "      <td>Not Known</td>\n",
       "      <td>0</td>\n",
       "      <td>16806</td>\n",
       "      <td>Male</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>100</td>\n",
       "      <td>General Surgery</td>\n",
       "      <td>0</td>\n",
       "      <td>2892</td>\n",
       "      <td>Male</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>101</td>\n",
       "      <td>Urology</td>\n",
       "      <td>0</td>\n",
       "      <td>2534</td>\n",
       "      <td>Male</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>107</td>\n",
       "      <td>Vascular Surgery</td>\n",
       "      <td>0</td>\n",
       "      <td>2</td>\n",
       "      <td>Male</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>110</td>\n",
       "      <td>Trauma and Orthopaedics</td>\n",
       "      <td>0</td>\n",
       "      <td>21182</td>\n",
       "      <td>Male</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  Main_Specialty_Code      Main_Specialty_Desc Age_Group Attendance_Count  \\\n",
       "1                   &                Not Known         0            16806   \n",
       "2                 100          General Surgery         0             2892   \n",
       "3                 101                  Urology         0             2534   \n",
       "4                 107         Vascular Surgery         0                2   \n",
       "5                 110  Trauma and Orthopaedics         0            21182   \n",
       "\n",
       "  Gender  \n",
       "1   Male  \n",
       "2   Male  \n",
       "3   Male  \n",
       "4   Male  \n",
       "5   Male  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Main_Specialty_Code</th>\n",
       "      <th>Main_Specialty_Desc</th>\n",
       "      <th>Age_Group</th>\n",
       "      <th>Attendance_Count</th>\n",
       "      <th>Gender</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>&amp;</td>\n",
       "      <td>Not Known</td>\n",
       "      <td>0</td>\n",
       "      <td>16162</td>\n",
       "      <td>Female</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>100</td>\n",
       "      <td>General Surgery</td>\n",
       "      <td>0</td>\n",
       "      <td>1479</td>\n",
       "      <td>Female</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>101</td>\n",
       "      <td>Urology</td>\n",
       "      <td>0</td>\n",
       "      <td>454</td>\n",
       "      <td>Female</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>107</td>\n",
       "      <td>Vascular Surgery</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>Female</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>110</td>\n",
       "      <td>Trauma and Orthopaedics</td>\n",
       "      <td>0</td>\n",
       "      <td>27130</td>\n",
       "      <td>Female</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  Main_Specialty_Code      Main_Specialty_Desc Age_Group Attendance_Count  \\\n",
       "1                   &                Not Known         0            16162   \n",
       "2                 100          General Surgery         0             1479   \n",
       "3                 101                  Urology         0              454   \n",
       "4                 107         Vascular Surgery         0                1   \n",
       "5                 110  Trauma and Orthopaedics         0            27130   \n",
       "\n",
       "   Gender  \n",
       "1  Female  \n",
       "2  Female  \n",
       "3  Female  \n",
       "4  Female  \n",
       "5  Female  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    },
    {
     "data": {
      "text/plain": [
       "array(['0', '1-4', '5-9', '10-14', '15', '16', '17', '18', '20-24',\n",
       "       '25-29', '30-34', '35-39', '40-44', '45-49', '50-54', '55-59',\n",
       "       '60-64', '65-69', '70-74', '75-79', '80-84', '85-89', '90-120',\n",
       "       'Unknown'], dtype=object)"
      ]
     },
     "execution_count": 15,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "import pandas as pd\n",
    "\n",
    "file_path = \"../data/hosp-epis-stat-outp-all-atte-2024-25-tab.xlsx\"\n",
    "\n",
    "# List of age group columns as they appear in Excel\n",
    "age_columns = ['0','1-4','5-9','10-14','15','16','17','18','20-24','25-29','30-34',\n",
    "               '35-39','40-44','45-49','50-54','55-59','60-64','65-69','70-74',\n",
    "               '75-79','80-84','85-89','90-120','Unknown']\n",
    "\n",
    "# Drop 'All Activity' before generating synthetic patients\n",
    "df = df[df['Main_Specialty_Desc'] != 'Total Activity']\n",
    "\n",
    "\n",
    "\n",
    "def load_and_melt(sheet_index, gender_label):\n",
    "    # Load sheet without header\n",
    "    df = pd.read_excel(file_path, sheet_name=sheet_index, header=None)\n",
    "    \n",
    "    # Drop first row (description)\n",
    "    df = df.drop(index=0).reset_index(drop=True)\n",
    "    \n",
    "    # Rename first two columns\n",
    "    df.rename(columns={0: 'Main_Specialty_Code', 1: 'Main_Specialty_Desc'}, inplace=True)\n",
    "    \n",
    "    # Keep only first two columns + age columns (ignore other NaNs)\n",
    "    all_columns = ['Main_Specialty_Code', 'Main_Specialty_Desc'] + list(range(2, 2+len(age_columns)))\n",
    "    df = df.iloc[:, :len(all_columns)]\n",
    "    df.columns = ['Main_Specialty_Code', 'Main_Specialty_Desc'] + age_columns\n",
    "    \n",
    "    # Melt into long format\n",
    "    df_long = df.melt(\n",
    "        id_vars=['Main_Specialty_Code','Main_Specialty_Desc'],\n",
    "        value_vars=age_columns,\n",
    "        var_name='Age_Group',\n",
    "        value_name='Attendance_Count'\n",
    "    )\n",
    "    \n",
    "    df_long['Gender'] = gender_label\n",
    "\n",
    "        # remove total-activity\n",
    "    df_long = df_long[df_long['Main_Specialty_Desc'] != 'Total Activity']\n",
    "    \n",
    "    return df_long\n",
    "\n",
    "# Load sheets\n",
    "all_long = load_and_melt(1, 'All')\n",
    "male_long = load_and_melt(2, 'Male')\n",
    "female_long = load_and_melt(3, 'Female')\n",
    "\n",
    "\n",
    "\n",
    "# Display\n",
    "display(all_long.head())\n",
    "display(male_long.head())\n",
    "display(female_long.head())\n",
    "\n",
    "\n",
    "all_long['Age_Group'].unique()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "28e61157-7f47-4bfd-b70c-59b71b7bc96c",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "All cleaned datasets have been saved to ../data/processed/\n"
     ]
    }
   ],
   "source": [
    "import os\n",
    "\n",
    "# Create folder if it doesn't exist\n",
    "os.makedirs(\"../data/processed\", exist_ok=True)\n",
    "\n",
    "# Save IMD and Ethnicity sheets\n",
    "imd_clean.to_csv(\"../data/processed/imd_no_show_probs.csv\", index=False)\n",
    "ethnic_clean.to_csv(\"../data/processed/ethnicity_no_show_probs.csv\", index=False)\n",
    "\n",
    "# Save long-format attendance sheets\n",
    "all_long.to_csv(\"../data/processed/attendance_all_long.csv\", index=False)\n",
    "male_long.to_csv(\"../data/processed/attendance_male_long.csv\", index=False)\n",
    "female_long.to_csv(\"../data/processed/attendance_female_long.csv\", index=False)\n",
    "\n",
    "print(\"All cleaned datasets have been saved to ../data/processed/\")\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.7"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
